# 固定翼控制算法——总能量控制

## 简介

​		固定翼位置控制模块采用了总能量算法用于控制升降（俯仰角）和油门，进而实现飞行速度和高度的控制。相比于传统算法，总能量算法实现了升降和油门的解耦，使控制效果更稳定、安全。

​		无人机总能量包括了势能和动能两部分，势能取决于飞行速度，而动能取决于飞行高度。

- 要想总能量增加，则需要加大油门（通过做功增加能量）；

- 势能与动能可以互相转换，可以通过降低高度使动能增加、势能减小，通过增加高度使动能减小、势能增加；

- 通过俯仰角的调节，实现高度的改变，进而实现动能和势能的转换；

​		故使用油门就可以控制总能量，通过调节俯仰角就可以平衡动能和势能。也就是说可以通过总能量需求来计算期望的油门量，通过总能量平衡需求来计算期望的俯仰角。

##  框图

输入：无人机可测量量，包括高度、真空速，期望高度、期望空速。

处理：根据高度和空速计算总能量、能量平衡

输出：油门期望、俯仰期望

```mermaid
flowchart LR
    测试速度 --> 测量动能
    测量高度 --> 测量势能
    subgraph 需求能量矩阵
    测量势能 & 测量动能 --> 当前总能量 & 当前能量平衡
    end
    
    期望速度 --> 期望动能
    期望高度 --> 期望势能
    subgraph 能量矩阵
    期望势能 & 期望动能 --> 总能量需求 & 能量平衡需求
    end
    
    当前总能量 --> 油门控制算法
    当前能量平衡 --> 升降控制算法
    
    总能量需求 --> 油门控制算法
    能量平衡需求 --> 升降控制算法
    
    油门控制算法 --> 期望油门
    升降控制算法 --> 期望俯仰角
```

## 理论

### 能量与做功

​		无人机总能量的增加是通过发动机做功实现的，而总能量的减小是通过降低发动机油门（即减小输出功率）实现的，输出功率减小，风阻一直做功导致总能量减小。

### 解耦的意义

​		对固定翼来说，油门的变化不仅会改变速度，也会改变高度，同样，升降的变化不仅会改变高度，也会改变速度。

​        我们使用$t$表示油门，$p$表示升降，$h$表示高度，$v$表示速度。由于油门与高度和速度都有关系，升降与高度和速度也都有关系，则可以通过矩阵$A$表示如下：
$$
\begin{pmatrix}
t \\
p
\end{pmatrix}=
\begin{bmatrix}
m1 & n1 \\
m2 & n2 \\
\end{bmatrix}*
\begin{pmatrix}
h \\
v
\end{pmatrix}\\=
A*
\begin{pmatrix}
h \\
v
\end{pmatrix}
$$
​    	由于$A$不是对角矩阵，故油门与升降是耦合在一起的。为了能够解耦，我们很自然的就希望，是否能够将$A$转变成一个对角矩阵形式呢？

​		假设存在一个矩阵$B$，并有$A=\Lambda*B$，且$\Lambda$是对角矩阵，也就是说：
$$
\begin{pmatrix}
t \\
p
\end{pmatrix}=
A*
\begin{pmatrix}
h \\
v
\end{pmatrix} =
\Lambda*B*
\begin{pmatrix}
h \\
v
\end{pmatrix}
$$
​		更进一步，我们定义势能$e_h$，动能$e_v$，并将$B$分解为$B=C*D$，且有：
$$
\begin{pmatrix}
e_h\\
e_v
\end{pmatrix}=D*
\begin{pmatrix}
h\\
v
\end{pmatrix}
$$
​		那么得到：
$$
\begin{pmatrix}
t \\
p
\end{pmatrix}=
A
\begin{pmatrix}
h \\
v
\end{pmatrix}=
\Lambda*C *
\begin{pmatrix}
e_h \\
e_v
\end{pmatrix}
$$
​		我们定义总能量为$e_a$，平衡能量为$e_b$，且有：
$$
\begin{pmatrix}
e_a \\
e_b
\end{pmatrix}=D*
\begin{pmatrix}
h \\
v
\end{pmatrix}
$$

> D就表示能量矩阵，将高度（势能）、速度（动能）转成了总能量、平衡能量。

​		那么可以得到：
$$
\begin{pmatrix}
t \\
p
\end{pmatrix}=\Lambda*
\begin{pmatrix}
e_a \\
e_b
\end{pmatrix} = 
\begin{bmatrix}
\lambda_1 & 0 \\
0 & \lambda_2
\end{bmatrix}*
\begin{pmatrix}
e_a \\
e_b
\end{pmatrix}
$$
​		我们知道，总能量与油门可认为是线性关系，平衡能量与升降也是线性关系 。这样，**通过总能量、平衡能量这对中间变量，实现了油门和升降的解耦**！！！

​		几个矩阵简单解释如下：

- 矩阵$D$：用于表示高度、速度与势能、动能的关系，虽然实际上动能与速度不是线性的，但为了做直观描述，我们暂时用$D$表示；

- 矩阵$C$：能量矩阵，用于表示势能、动能与总能量、平能能量的关系，且$C$表示如下：
  $$
  C=\begin{bmatrix}
  1 & 1 \\
  1 & -1
  \end{bmatrix}
  $$
  即：总能量=势能+动能，平能能量=势能-动能。

### 能量计算

#### 总能量

总能量由势能加动能组成：
$$
E_T=mgh+\frac{1}{2}m{V_T}^2
$$
其中：

- 真空速TAS：$V_T$
- 无人机质量：$m$
- 高度：$h$

**要使总能量增加就需要通过发动机做功来实现！**发动机的转速直接对应了输出功率，而发动机输出功率与总能量变化率息息相关。

总能量变化率：
$$
\dot{E_T}=\frac{dE}{dt}=mg\dot{h}+mV_T\dot{V_T}
$$
质量归一化，认为$mg=1$，两边同除以$mg$后有
$$
\dot{E_T}=\dot{h}+\frac{V_T\dot{V_T}}{g}
$$
两边除以速度后有：
$$
\frac{\dot{E_T}}{V_T}=\frac{\dot{h}}{V_T}+\frac{\dot{V_T}}{g}=sin(\gamma)+\frac{\dot{V_T}}{g}
$$
其中$\gamma$是飞行计划角度（flight plan angle），可以认为表示“俯仰”。

根据飞机的动力学方程，我们有以下关系：
$$
T-D=mg(sin(\gamma)+\frac{\dot{V_T}}{g})
$$
其中T和D是推力和阻力，在水平飞行中，初始推力会根据阻力进行微调，推力的变化会导致：
$$
\Delta T=mg(sin(\gamma)+\frac{\dot{V_T}}{g})
$$
也就是说，$\Delta T$正比于$\dot{E}$，故无人机的推力设置值用于总能量控制。

当$\gamma$很小时，有：
$$
sin(\gamma)\approx\gamma
$$


#### 平衡能量

对升降（俯仰）的控制是能量守恒的，因此用来交换动力能量。控制升降舵使无人机低头（俯冲）可以将势能转换为动能，反正将动能转换为势能。 

平衡能量定义为势能-动能，即：
$$
B=mgh-\frac{1}{2}m{V_T}^2
$$
两边求导，得到平衡能量变化率：
$$
\dot{B}=mg\dot{h}-mV_T\dot{V_T}
$$


平衡能量变化率定义为：
$$
\dot{B}=\gamma-\frac{\dot{V_T}}{g}
$$

若保持油门不变（也就是总能量不变）当无人机有一定俯仰角时（例如俯仰角为正），产生高度变化率$\dot{h}$，同时无人机速度会下降。

![image-20240425103345227](imgs/image-20240425103345227.png)

故根据上图可知，短时间内可认为高度变化率（垂直速度）可由俯仰角和无人机速度得到：
$$
\dot{h}=V_T=V*sin(\gamma)\\
$$
无人机速度变化率（加速度）可根据俯仰角和重量加速度计算，故有：
$$
\dot{V}=g*sin(\gamma)
$$
本质上，改变俯仰角后，势能与动能互相转化，短时间内势能变化率和动能变化率肯定是绝对值相等而符号相反。

势能与动能的转换关系通过公式表示如下：
$$
mg\dot{h}=m*g*V*sin(\gamma)=\\
m*V*g*sin(\gamma)=
m*V*\dot{V}
$$
从上式可以看到，势能转化为了动能。

### 控制

#### 油门控制

​		对固定翼来说，发动机是一个做功设备，油门对应的是功率（即总能量变化率），油门越高、时间越久，总能量增加越多。

​		也就是，如果希望飞的更高，高度就要增加，势能变化率＞0，总能量变化率>0，那么油门就要增加；同样，如果希望飞的更快，速度就要增加，动能变化率>0，那么油门也要增加。

#### 俯仰控制

如果希望高度增加（势能变化率>0），速度不变（动能变化率=0），能量分配变化率>0，期望俯仰角则>0；

如果希望高度不变（势能变化率=0），速度减小（动能变化率<0），能量分配变化率>0，期望俯仰角则>0，速度的减小其实会通过减小油门的方式实现；



### 控制逻辑

|                    | 总能量变化率 | 能量分配变化率 | 油门 | 俯仰 |
| ------------------ | ------------ | -------------- | ---- | ---- |
| 高度增加，速度不变 | >0           | >0             | 增加 | 增加 |
| 高度减小，速度不变 | <0           | <0             | 减小 | 减小 |
| 高度不变，速度增加 | >0           | <0             | 增加 | 不变 |
| 高度不变，速度减小 | <0           | >0             | 增加 | 不变 |



## PX4控制

### 简介

#### 总能量计算

在PX4中，总能量计算如下：
$$
STE=SKE+SPE=
0.5*V_{TAS}*V_{TAS}
+
g*H
$$
其中$V_{TAS}$是真空速，$H$为海拔高度。

总能量变化率：
$$
E_{rate}=V_{TAS}*V_{rate}+g*V_z
$$
其中$V_{rate}$为真空速变化率，$V_z$为高度变化率。

#### 平衡能量计算

​		平衡能量就是势能与动能的差，为了能够根据场景需求，增加了高度（势能）比重$W_h$和速度（动能）比重$W_v$，平衡能量计算考虑了比重，如下：
$$
SEB=SPE*W_h-SKE*W_v
$$



### 油门控制

根据代码，进行简化，油门控制算法示意图如下：

```mermaid
graph LR
STE_sp(STE目标)-->STE_err(STE_err)-->throttle_P(油门P)-->out(油门setpoint)
STE(STE实际)-->STE_err-->throttle_I(油门I)-->out

STE_rate_sp(STE_rate目标)-->STE_rate_err(SEB_err)--一阶滤波-->throttle_D(油门D)-->out
STE_rate(STE_rate实际)-->STE_rate_err

STE_rate_t(STE_rate)-->STE_rate_target(STE_rate目标量)--线性对应表-->throttle_predict(预测油门)-->out
f(转弯诱导阻力)-->STE_rate_target
```

总能量误差

​		总能量误差为势能误差与动能误差之和。
$$
STE_{err}=SPE_{sp}-SPE_{est}+SKE_{sp}-SKE_{est}
$$
能量平衡误差

​		能量平衡误差为能量平衡期望与能量平衡做差。
$$
SEB_{err}=\\(SPE_{sp}*SPE_{weight}-SKE_{sp}*SKE_{weight})-\\
(SPE_{est}*SPE_{weight}-SKE_{est}*SKE_{weight})
$$

PX4官方给出的控制原理框图如下：

![image-20240130214310369](imgs/image-20240130214310369.png)

### 俯仰控制

​		PX4将动能和重力势能的分配叫Energy Balance，有一个分配相关的重要参数能量分配权重W，W可在0到2之间变化，公式如下：

​		$SEB = W*动能+（2-W)*势能$

​		即当W=0时，放弃速度控制，只控制高度，W=2时，放弃高度控制只控制速度，W=1时，既控制速度也控制高度，二者的权重是1：1。

```mermaid
graph LR
SEB_sp(SEB目标)-->SEB_err(SEB_err)-->pitch_P(俯仰P)-->climb(爬升角)--climb_angle_to_SEB_rate-->out(俯仰setpoint)
SEB(SEB实际)-->SEB_err-->pitch_I(俯仰I)-->climb

SEB_rate_sp(SEB_rate目标)-->SEB_rate_err(SEB_err)-->pitch_D(俯仰D)
SEB_rate(SEB_rate实际)-->SEB_rate_err-->pitch_D-->climb

SEB_rate_t(SEB_rate目标量)-->out
```

​		PX4官方给出的控制原理框图如下：

![image-20240130214330829](imgs/image-20240130214330829.png)

## 附录

### 术语

#### flight plan angle

飞行路径角，将速度矢量分解为垂直位置矢量分量和平行位置矢量分量，飞行路径角就是速度矢量和垂直位置矢量分量夹角

#### IAS

指示空速，即表速，由空速计动压静压进行计算。

#### TAS

TAS是True airspeed的缩写，即真空速，无人机相对空气的速度。

#### EAS

当量空速，低速情况下与IAS相同。

